{% extends 'shop/base.html' %}
{% block content %}

<div style="max-width: 1000px; margin: 60px auto; padding: 32px;
            background:#fff; border-radius:16px;
            box-shadow:0 8px 24px rgba(0,0,0,.08);">

  <h2 style="text-align:center; margin-bottom:42px; font-size:28px; font-weight:700;">
    내 문의 내역
  </h2>
  <hr style="border:1px solid #ddd; margin-bottom:4px;">

  {% if comments %}
    <ul style="list-style:none; padding:0; margin:0;">
      {% for comment in comments %}
        <li style="border-bottom:1px solid #ddd; padding:8px 0; margin-top:0;">

          {% if comment.title %}
            <div style="margin-top:6px; margin-bottom:4px; font-size:24px; font-weight:600;">
              Title -- {{ comment.title }}
            </div>
          {% endif %}

          <div style="margin-top:8px; font-size:20px; font-weight:600;">Content</div>
          <p style="margin:0; line-height:1.6; white-space:pre-line;">{{ comment.content }}</p>

          {% if comment.uploaded_image %}
            <div style="margin-top:20px;">
              <img src="{{ comment.uploaded_image.url }}"
                   alt=""
                   class="comment-img"
                   style="width:160px;height:160px;object-fit:cover;border-radius:6px;
                          border:1px solid #eee; cursor:pointer;">
            </div>
          {% endif %}

          {# ---- 하단 footer: 왼쪽 작성자/날짜, 오른쪽 버튼 ---- #}
          <div style="display:flex; align-items:center; margin-top:8px;">
            <div style="color:#6c757d; font-size:14px;">
              <strong>Username - {{ comment.author }}</strong>
              <span style="margin-left:8px;">{{ comment.created_date|date:"Y-m-d H:i" }}</span>
            </div>
            {% if comment.author == user %}
              <div style="display:flex; gap:8px; margin-left:auto; padding-right:20px;">
                <!-- Edit button -->
                <a href="{% url 'updatecomment' comment.pk %}"
                   onclick="return confirm('Are you sure you want to edit this comment?')"
                   style="padding:6px 10px; border:none; border-radius:6px;
                          text-decoration:none; background:#212529; color:#fff;
                          font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
                          transition:background 0.2s;"
                   onmouseover="this.style.background='#343a40'"
                   onmouseout="this.style.background='#212529'">
                   Edit
                </a>
                <!-- Delete button -->
                <form action="{% url 'deletecomment' comment.pk %}" method="post" style="display:inline; margin:0;"
                      onsubmit="return confirm('Are you sure you want to delete this comment?')">
                  {% csrf_token %}
                  <button type="submit"
                      style="padding:6px 10px; border:none; border-radius:6px;
                             background:#212529; color:#fff; cursor:pointer;
                             font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
                             transition:background 0.2s;"
                      onmouseover="this.style.background='#343a40'"
                      onmouseout="this.style.background='#212529'">
                      Del
                  </button>
                </form>
              </div>
            {% endif %}
          </div>
          {# ---- /footer ---- #}

          {# ---- 관리자 전용 대댓글 달기 버튼 ---- #}
          {% if request.user.is_staff %}
            <div style="margin-top:6px;">
              <button type="button"
                      onclick="toggleReply('{{ comment.id }}')"
                      style="padding:6px 10px; border:1px solid #ced4da; border-radius:6px; background:#fff; cursor:pointer;">
                답글 달기
              </button>
            </div>
            <form id="reply-form-{{ comment.id }}"
                  action="{% url 'reply_comment' comment.id %}"
                  method="post"
                  style="display:none; margin-top:8px; padding:10px; border:1px solid #eee; border-radius:8px; background:#fafafa;">
              {% csrf_token %}
              <textarea name="content" required placeholder="답글 내용을 입력하세요"
                        style="width:100%; min-height:90px; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:8px;"></textarea>
              <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" onclick="toggleReply('{{ comment.id }}')"
                        style="padding:8px 12px; border:1px solid #ccc; border-radius:6px; background:#fff;">취소</button>
                <button type="submit"
                        style="padding:8px 12px; border:1px solid #0d6efd; background:#0d6efd; color:#fff; border-radius:6px;">등록</button>
              </div>
            </form>
          {% endif %}

          {# ---- 대댓글 목록 ---- #}
          {% if comment.replies.all %}
            <ul style="list-style:none; padding:0; margin:12px 0 12px 0;">
              {% for reply in comment.replies.all %}
                <li style="margin-bottom:13px; padding:8px 12px; border-left:3px solid #e9ecef; background:#fafafa; border-radius:8px;">
                  <div style="display:flex; justify-content:space-between; color:#6c757d; font-size:14px;">
                    <span>
                      <strong>
                        {{ reply.author }}
                        {% if reply.author.is_staff %}
                          <span style="font-size:12px; color:#0d6efd; border:1px solid #0d6efd; border-radius:4px; padding:1px 6px; margin-left:6px;">
                            관리자
                          </span>
                        {% endif %}
                      </strong>
                    </span>
                    <span>{{ reply.created_date|date:"Y-m-d H:i" }}</span>
                  </div>
                  <div style="margin-top:4px; margin-bottom:4px; line-height:1.4; white-space:pre-line;">
                    {{ reply.content }}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% endif %}

        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>아직 등록된 문의가 없습니다.</p>
  {% endif %}
</div>

<!-- 이미지 확대 모달 -->
<div id="imgModal" style="display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;
                           background:rgba(0,0,0,0.8);align-items:center;justify-content:center;">
  <span id="imgClose" style="position:absolute;top:20px;right:35px;color:#fff;font-size:40px;cursor:pointer;">&times;</span>
  <img id="imgModalContent" style="max-width:90%;max-height:90%;border-radius:8px;">
</div>

<script>
  // 이미지 모달
  (function () {
    const modal = document.getElementById("imgModal");
    const modalImg = document.getElementById("imgModalContent");
    const modalClose = document.getElementById("imgClose");
    document.querySelectorAll(".comment-img").forEach(img => {  
      img.addEventListener("click", () => { modal.style.display = "flex"; modalImg.src = img.src; });
    });
    modalClose.addEventListener("click", () => { modal.style.display = "none"; });
    modal.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });
  })();

  // 대댓글 폼 토글
  function toggleReply(id){
    const el = document.getElementById('reply-form-' + id);
    if(!el) return;
    el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
  }
</script>

{% endblock %}
